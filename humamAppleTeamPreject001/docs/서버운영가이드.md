# MusicSpace — 서버 운영 가이드

---

## 목차

1. [서비스 구성](#1-서비스-구성)
2. [기본 운영 명령어](#2-기본-운영-명령어)
3. [개별 서비스 관리](#3-개별-서비스-관리)
4. [로그 관리](#4-로그-관리)
5. [DB 관리](#5-db-관리)
6. [Redis 관리](#6-redis-관리)
7. [장애 대응](#7-장애-대응)
8. [성능 모니터링](#8-성능-모니터링)
9. [백업 및 복구](#9-백업-및-복구)
10. [API 테스트](#10-api-테스트)

---

## 1. 서비스 구성

| 컨테이너 | 역할 | 포트 (내부) | 재시작 정책 |
|----------|------|------------|-----------|
| musicspace-frontend | Nginx + React 정적 파일 | 80, 443, 8443 | unless-stopped |
| musicspace-spring-backend | Spring Boot API | 8080 | unless-stopped |
| musicspace-fastapi | FastAPI AI/ML | 8000 | unless-stopped |
| musicspace-backend | Node.js Playwright | 3001 | unless-stopped |
| musicspace-db | MariaDB | 3306 | unless-stopped |
| musicspace-redis | Redis | 6379 | unless-stopped |

**Docker Compose 파일:**

| 파일 | 용도 |
|------|------|
| `docker-compose.macbook-dockerhub.yml` | MacBook 전체 스택 (권장) |
| `docker-compose.fullstack-local.yml` | 개발용 전체 스택 |
| `docker-compose.frontend-local.yml` | 프론트엔드만 단독 실행 |

---

## 2. 기본 운영 명령어

```bash
# 작업 디렉토리
cd /Users/woosungjo/Team_final_project/humamAppleTeamPreject001

COMPOSE="docker compose -f docker-compose.macbook-dockerhub.yml"

# 전체 시작 (이미지 재빌드 없이)
$COMPOSE up -d

# 전체 시작 (이미지 재빌드 포함)
$COMPOSE up -d --build

# 전체 종료 (데이터 보존)
$COMPOSE down

# 전체 종료 + 볼륨 삭제 (DB 초기화 주의!)
$COMPOSE down -v

# 전체 재시작
$COMPOSE restart

# 서비스 상태 확인
$COMPOSE ps

# 전체 로그 (실시간)
$COMPOSE logs -f

# 특정 서비스 로그
$COMPOSE logs -f spring-backend
$COMPOSE logs -f fastapi
```

---

## 3. 개별 서비스 관리

### 프론트엔드 (Nginx)

```bash
# 재시작
docker restart musicspace-frontend

# 재빌드 후 재시작
docker compose -f docker-compose.macbook-dockerhub.yml up -d --build frontend
# 또는 스크립트 사용
./deploy-frontend.sh

# Nginx 설정 리로드 (재빌드 없이)
docker exec musicspace-frontend nginx -s reload

# Nginx 설정 문법 검사
docker exec musicspace-frontend nginx -t
```

### Spring Boot 백엔드

```bash
# 재시작
docker restart musicspace-spring-backend

# 재빌드
docker compose -f docker-compose.macbook-dockerhub.yml up -d --build spring-backend

# JVM 힙 사용량 확인
docker exec musicspace-spring-backend jcmd 1 VM.heap_info
```

### FastAPI

```bash
# 재시작
docker restart musicspace-fastapi

# 재빌드
docker compose -f docker-compose.macbook-dockerhub.yml up -d --build fastapi

# 헬스체크
curl http://localhost:8000/health

# 모델 파일 확인
docker exec musicspace-fastapi ls -lh /app/M1/ /app/M2/ /app/M3/
```

### Node.js (Playwright)

```bash
# 재시작
docker restart musicspace-backend

# Playwright 브라우저 상태 확인
docker exec musicspace-backend node -e "console.log('ok')"
```

---

## 4. 로그 관리

### 실시간 로그

```bash
# 전체 서비스 로그
docker compose -f docker-compose.macbook-dockerhub.yml logs -f

# 특정 서비스
docker logs -f musicspace-spring-backend
docker logs -f musicspace-fastapi
docker logs -f musicspace-frontend
docker logs -f musicspace-db
```

### 로그 필터링

```bash
# 에러만 보기
docker logs musicspace-spring-backend 2>&1 | grep -i error

# 최근 100줄
docker logs --tail 100 musicspace-spring-backend

# 특정 시간 이후
docker logs --since="2026-02-12T00:00:00" musicspace-spring-backend
```

### 로그 크기 제한 (docker-compose에 추가 권장)

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "3"
```

---

## 5. DB 관리

### 접속

```bash
# 컨테이너 내부에서
docker exec -it musicspace-db mariadb \
  -u musicspace -pmusicspace123 music_space_db

# 외부에서 (3306 포트 열린 경우)
mysql -h 127.0.0.1 -P 3306 -u musicspace -pmusicspace123 music_space_db
```

### 자주 쓰는 쿼리

```sql
-- 테이블 목록
SHOW TABLES;

-- 트랙 오디오 특성 커버리지 확인
SELECT
  COUNT(*) AS total,
  SUM(danceability IS NOT NULL) AS enriched,
  ROUND(SUM(danceability IS NOT NULL) / COUNT(*) * 100, 1) AS pct
FROM tracks;

-- 사용자별 PMS 트랙 수
SELECT user_id, COUNT(*) AS track_count
FROM pms_tracks
GROUP BY user_id
ORDER BY track_count DESC
LIMIT 20;

-- 최근 가입 사용자
SELECT user_id, username, email, created_at
FROM users
ORDER BY created_at DESC
LIMIT 10;

-- 플레이리스트 목록 (EMS)
SELECT playlist_id, title, platform, track_count, created_at
FROM ems_playlists
ORDER BY created_at DESC
LIMIT 10;
```

### 스키마 마이그레이션

```bash
# SQL 파일 실행
docker exec -i musicspace-db mariadb \
  -u musicspace -pmusicspace123 music_space_db < docs/dbSchema.sql
```

---

## 6. Redis 관리

```bash
# Redis CLI 접속
docker exec -it musicspace-redis redis-cli

# 저장된 키 확인 (refresh token)
redis-cli -h 127.0.0.1 keys "refresh:*"

# 특정 키 조회
redis-cli -h 127.0.0.1 get "refresh:{userId}"

# TTL 확인
redis-cli -h 127.0.0.1 ttl "refresh:{userId}"

# 메모리 사용량
redis-cli -h 127.0.0.1 info memory

# 전체 키 수
redis-cli -h 127.0.0.1 dbsize
```

---

## 7. 장애 대응

### 서비스별 장애 원인 및 해결

#### 프론트엔드 502 Bad Gateway

```bash
# 업스트림 서비스 상태 확인
docker ps --filter "name=musicspace"

# Nginx 에러 로그
docker logs musicspace-frontend | grep "upstream"

# 업스트림 컨테이너 재시작
docker restart musicspace-spring-backend
```

#### Spring Boot 시작 실패

```bash
docker logs musicspace-spring-backend | tail -50

# 주요 원인:
# 1. DB 연결 실패 → DB 컨테이너 healthcheck 확인
docker inspect musicspace-db | grep -A5 Health

# 2. Redis 연결 실패
docker logs musicspace-redis

# 3. 포트 충돌
lsof -i :8080
```

#### FastAPI 모델 로딩 실패

```bash
docker logs musicspace-fastapi | grep -E "ERROR|Exception"

# 모델 파일 존재 확인
docker exec musicspace-fastapi ls -la /app/M2/tfidf_gbr_models.pkl
docker exec musicspace-fastapi ls -la /app/M1/audio_predictor.pkl
docker exec musicspace-fastapi ls -la /app/M3/
```

#### DB 연결 실패 (Too many connections)

```sql
-- 현재 연결 수 확인
SHOW STATUS LIKE 'Threads_connected';
SHOW PROCESSLIST;

-- 유휴 연결 강제 종료
KILL {process_id};

-- max_connections 확인
SHOW VARIABLES LIKE 'max_connections';
```

#### 포트 충돌

```bash
# 사용 중인 포트 확인
lsof -i :80
lsof -i :443
lsof -i :8443

# 기존 컨테이너 강제 삭제
docker rm -f musicspace-frontend
docker compose -f docker-compose.macbook-dockerhub.yml up -d frontend
```

#### Docker 디스크 공간 부족

```bash
# 디스크 사용량 확인
docker system df

# 미사용 리소스 정리
docker system prune -f

# 미사용 이미지만 정리
docker image prune -f

# 볼륨 정리 (주의: 데이터 삭제)
docker volume prune -f
```

---

## 8. 성능 모니터링

```bash
# 컨테이너 리소스 사용량 (실시간)
docker stats

# 특정 컨테이너
docker stats musicspace-spring-backend musicspace-fastapi

# FastAPI 응답 시간 테스트
curl -w "\n응답시간: %{time_total}s\n" \
  http://localhost:8000/health

# Spring Boot 헬스체크
curl http://localhost:8080/actuator/health 2>/dev/null || \
  curl http://localhost:8080/api/health
```

---

## 9. 백업 및 복구

### DB 백업

```bash
# 전체 DB 덤프
docker exec musicspace-db mysqldump \
  -u musicspace -pmusicspace123 \
  music_space_db > backup_$(date +%Y%m%d).sql

# 특정 테이블만
docker exec musicspace-db mysqldump \
  -u musicspace -pmusicspace123 \
  music_space_db tracks playlists users \
  > backup_tables_$(date +%Y%m%d).sql
```

### DB 복구

```bash
docker exec -i musicspace-db mariadb \
  -u musicspace -pmusicspace123 \
  music_space_db < backup_20260212.sql
```

### 업로드 파일 백업

```bash
# 업로드 이미지 백업
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz \
  public/images/ public/uploads/
```

---

## 10. API 테스트

### 헬스체크

```bash
# FastAPI
curl https://imapplepie20.tplinkdns.com:8443/api/m1/health

# Spring Boot (Nginx 통해서)
curl https://imapplepie20.tplinkdns.com:8443/api/health

# 직접 접근
curl http://localhost:8080/actuator/health  # Spring Boot
curl http://localhost:8000/health           # FastAPI
curl http://localhost:3001/health           # Node.js
```

### 로그인 테스트

```bash
# 로그인
TOKEN=$(curl -s -X POST https://imapplepie20.tplinkdns.com:8443/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"test123"}' \
  | python3 -c "import sys,json; print(json.load(sys.stdin)['accessToken'])")

echo "Token: $TOKEN"

# 내 정보 조회
curl -H "Authorization: Bearer $TOKEN" \
  https://imapplepie20.tplinkdns.com:8443/api/auth/me
```

### Audio Enrichment 상태 확인

```bash
curl https://imapplepie20.tplinkdns.com:8443/api/enrich-status
```

### M2 오디오 특성 예측 테스트

```bash
curl -X POST https://imapplepie20.tplinkdns.com:8443/api/m2/predict-audio \
  -H "Content-Type: application/json" \
  -d '{
    "tracks": [
      {"track_id": 1, "title": "Bohemian Rhapsody", "artist": "Queen"},
      {"track_id": 2, "title": "Blinding Lights", "artist": "The Weeknd"}
    ]
  }'
```
