# MusicSpace 서버 운영 가이드

## 목차
1. [서비스 구성](#서비스-구성)
2. [Docker Compose 명령어](#docker-compose-명령어)
3. [개별 서비스 관리](#개별-서비스-관리)
4. [로그 확인](#로그-확인)
5. [문제 해결](#문제-해결)
6. [API 테스트](#api-테스트)

---

## 서비스 구성

| 서비스 | 컨테이너명 | 포트 | 설명 |
|--------|-----------|------|------|
| MariaDB | musicspace-db | 3306 | 데이터베이스 |
| Redis | musicspace-redis | 6379 | 캐시/세션 |
| Spring Boot | musicspace-spring-backend | 8080 | Java API 서버 |
| Node.js | musicspace-backend | 3001 | Node.js API 서버 |
| Frontend | musicspace-frontend | 80 | React 프론트엔드 |

---

## Docker Compose 명령어

### 전체 서비스 관리

```bash
# 프로젝트 디렉토리로 이동
cd /path/to/humamAppleTeamPreject001

# 전체 시작
docker-compose up -d

# 전체 중지
docker-compose stop

# 전체 중지 및 컨테이너 삭제
docker-compose down

# 전체 중지 + 볼륨 삭제 (데이터 초기화)
docker-compose down -v

# 전체 재시작
docker-compose restart

# 상태 확인
docker-compose ps
```

### 이미지 빌드

```bash
# 전체 빌드
docker-compose build

# 캐시 없이 전체 빌드
docker-compose build --no-cache

# 특정 서비스만 빌드
docker-compose build spring-backend
docker-compose build backend
docker-compose build frontend
```

---

## 개별 서비스 관리

### Spring Boot (musicspace-spring-backend)

```bash
# 시작
docker-compose up -d spring-backend

# 중지
docker-compose stop spring-backend

# 재시작
docker-compose restart spring-backend

# 재빌드 후 시작
docker-compose up -d --build spring-backend

# 로그 확인
docker logs musicspace-spring-backend -f

# 컨테이너 접속
docker exec -it musicspace-spring-backend sh
```

### Node.js Backend (musicspace-backend)

```bash
# 시작
docker-compose up -d backend

# 중지
docker-compose stop backend

# 재시작
docker-compose restart backend

# 로그 확인
docker logs musicspace-backend -f

# 컨테이너 접속
docker exec -it musicspace-backend sh
```

### Frontend (musicspace-frontend)

```bash
# 시작
docker-compose up -d frontend

# 중지
docker-compose stop frontend

# 재시작
docker-compose restart frontend

# 로그 확인
docker logs musicspace-frontend -f
```

### MariaDB (musicspace-db)

```bash
# 시작
docker-compose up -d db

# 중지
docker-compose stop db

# 재시작
docker-compose restart db

# MySQL 클라이언트 접속
docker exec -it musicspace-db mysql -u musicspace -pmusicspace123 music_space_db

# SQL 파일 실행
docker exec -i musicspace-db mysql -u musicspace -pmusicspace123 music_space_db < file.sql

# 외부 IP 접속 허용 추가
docker exec musicspace-db mysql -u root -pmusicspace123 -e "
CREATE USER IF NOT EXISTS 'musicspace'@'NEW_IP' IDENTIFIED BY 'musicspace123';
GRANT ALL PRIVILEGES ON music_space_db.* TO 'musicspace'@'NEW_IP';
FLUSH PRIVILEGES;"

# 현재 허용된 호스트 확인
docker exec musicspace-db mysql -u root -pmusicspace123 -e "SELECT User, Host FROM mysql.user WHERE User = 'musicspace';"
```

**현재 허용된 외부 IP:** `175.195.36.16`

### Redis (musicspace-redis)

```bash
# 시작
docker-compose up -d redis

# 중지
docker-compose stop redis

# Redis CLI 접속
docker exec -it musicspace-redis redis-cli

# 모든 키 확인
docker exec -it musicspace-redis redis-cli KEYS "*"

# 캐시 초기화
docker exec -it musicspace-redis redis-cli FLUSHALL
```

---

## 로그 확인

### 실시간 로그

```bash
# 전체 서비스 로그
docker-compose logs -f

# 특정 서비스 로그
docker-compose logs -f spring-backend
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f db

# 최근 100줄만
docker logs musicspace-spring-backend --tail 100

# 특정 시간 이후 로그
docker logs musicspace-spring-backend --since 1h
docker logs musicspace-spring-backend --since 30m
```

### 로그 검색

```bash
# 에러 로그만
docker logs musicspace-spring-backend 2>&1 | grep -i error

# 특정 키워드 검색
docker logs musicspace-spring-backend 2>&1 | grep "gms"
```

---

## 문제 해결

### 프로세스 강제 종료

```bash
# 컨테이너 강제 종료
docker kill musicspace-spring-backend

# 모든 컨테이너 강제 종료
docker kill $(docker ps -q)

# 중지된 컨테이너 삭제
docker container prune

# 사용하지 않는 이미지 삭제
docker image prune

# 전체 정리 (주의!)
docker system prune -a
```

### 포트 충돌 확인

```bash
# 포트 사용 확인 (Linux)
sudo lsof -i :8080
sudo lsof -i :3001
sudo lsof -i :3306

# 포트 사용 프로세스 종료 (Linux)
sudo kill -9 $(sudo lsof -t -i:8080)
```

### 컨테이너 상태 확인

```bash
# 상세 상태
docker inspect musicspace-spring-backend

# 리소스 사용량
docker stats

# 헬스 체크 상태
docker inspect --format='{{.State.Health.Status}}' musicspace-spring-backend
```

### 컨테이너 재생성

```bash
# 컨테이너 삭제 후 재생성
docker-compose up -d --force-recreate spring-backend

# 이미지까지 재빌드
docker-compose up -d --build --force-recreate spring-backend
```

---

## API 테스트

### 헬스 체크

```bash
# Spring Boot 헬스 체크
curl http://localhost:8080/api/actuator/health

# Node.js 헬스 체크
curl http://localhost:3001/health
```

### GMS API 테스트

```bash
# 추천 플레이리스트 조회
curl http://localhost:8080/api/api/gms/recommend-playlists/1

# AI 모델 학습 완료 콜백
curl -X POST http://localhost:8080/api/api/gms/success-first-model \
  -H "Content-Type: application/json" \
  -d '{"userId": 1}'

# EMS 플레이리스트 생성
curl -X POST "http://localhost:8080/api/api/gms/make-ems-playlists/1?recommendCount=3"

# 추천 트랙 수신
curl -X POST http://localhost:8080/api/api/gms/send-recommend-tracks \
  -H "Content-Type: application/json" \
  -d '{"userId": 1, "tracks": [{"trackId": 1, "title": "Test", "artist": "Artist", "score": 0.9}]}'
```

---

## 배포 스크립트

### 원라인 배포

```bash
cd /path/to/project && git pull && docker-compose down && docker-compose build --no-cache && docker-compose up -d
```

### 배포 스크립트 (deploy.sh)

```bash
#!/bin/bash
set -e

echo "=== MusicSpace 배포 시작 ==="

cd /path/to/humamAppleTeamPreject001

echo "1. 최신 코드 Pull"
git pull origin main

echo "2. 컨테이너 중지"
docker-compose down

echo "3. 이미지 빌드"
docker-compose build --no-cache

echo "4. 컨테이너 시작"
docker-compose up -d

echo "5. 헬스 체크 대기 (30초)"
sleep 30

echo "6. 상태 확인"
docker-compose ps
curl -s http://localhost:8080/api/actuator/health

echo "=== 배포 완료 ==="
```

---

## 자주 사용하는 명령어 요약

| 작업 | 명령어 |
|------|--------|
| 전체 시작 | `docker-compose up -d` |
| 전체 중지 | `docker-compose down` |
| 상태 확인 | `docker-compose ps` |
| 로그 보기 | `docker-compose logs -f` |
| 재빌드 | `docker-compose build --no-cache` |
| 재시작 | `docker-compose restart` |
| 강제 종료 | `docker kill <container>` |
| DB 접속 | `docker exec -it musicspace-db mysql -u musicspace -pmusicspace123 music_space_db` |
| Redis 접속 | `docker exec -it musicspace-redis redis-cli` |
